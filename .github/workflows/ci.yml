name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.23'

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ env.GO_VERSION }}-
            ${{ runner.os }}-go-
      - run: go mod download
      - run: go test -race -covermode=atomic -coverprofile=coverage.out ./pkg/...
      - run: go test -bench=. -benchmem ./pkg/... | tee benchmark.txt
      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-go-${{ env.GO_VERSION }}-${{ github.sha }}
          path: benchmark.txt
      - uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.7.2
          args: --timeout=5m
          skip-cache: true
          skip-pkg-cache: true

  vulncheck:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - run: go mod download
      - run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          if govulncheck ./... > vuln.txt 2>&1; then
            exit 0
          fi
          if grep -v "GO-[0-9]" vuln.txt | grep -q "Vulnerability"; then
            cat vuln.txt
            exit 1
          fi
          exit 0

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint, vulncheck]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - run: go build -trimpath -buildvcs=false -ldflags "-X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Version=dev -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Commit=$(git rev-parse --short HEAD) -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o tunnel-dash ./cmd/tunnel-dash
      - run: ./tunnel-dash --help
      - run: ./tunnel-dash --version
      - run: |
          go build -trimpath -buildvcs=false -ldflags "-X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Version=test -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Commit=abc123 -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.BuildDate=2024-01-01T00:00:00Z" -o tunnel-dash-1 ./cmd/tunnel-dash
          go build -trimpath -buildvcs=false -ldflags "-X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Version=test -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Commit=abc123 -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.BuildDate=2024-01-01T00:00:00Z" -o tunnel-dash-2 ./cmd/tunnel-dash
          [ "$(sha256sum tunnel-dash-1 | cut -d' ' -f1)" = "$(sha256sum tunnel-dash-2 | cut -d' ' -f1)" ] || exit 1
