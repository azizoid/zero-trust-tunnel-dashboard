name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  GO_VERSION: '1.23'

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        go-version: ['1.21', '1.22', '1.23']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      
      - name: Cache Go modules and build cache
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-
            ${{ runner.os }}-go-
      
      - name: Download dependencies
        run: go mod download
      
      - name: Run tests
        run: go test -race -covermode=atomic -coverprofile=coverage.out ./pkg/...
      
      - name: Run benchmarks
        if: matrix.go-version == '1.23'
        run: go test -bench=. -benchmem ./pkg/... | tee benchmark.txt
      
      - name: Upload benchmark results
        if: matrix.go-version == '1.23'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-go-${{ matrix.go-version }}-${{ github.sha }}
          path: benchmark.txt
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.go-version == '1.23'
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: v2.7.2
          args: --timeout=5m

  vulncheck:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Download dependencies
        run: go mod download
      
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      
      - name: Run govulncheck
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          echo "Running vulnerability check..."
          govulncheck ./... | tee vuln.txt || true
          # Fail only on non-stdlib vulnerabilities
          if grep -E "GO-[0-9]+" vuln.txt 2>/dev/null; then
            echo "::error::Non-stdlib vulnerabilities found. Review the output above."
            exit 1
          else
            echo "✅ No non-stdlib vulnerabilities found"
            echo "Note: Standard library vulnerabilities are fixed by upgrading Go version."
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint, vulncheck]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Build
        run: go build -trimpath -buildvcs=false -ldflags "-X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Version=dev -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Commit=$(git rev-parse --short HEAD) -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)" -o tunnel-dash ./cmd/tunnel-dash
      
      - name: Verify binary
        run: |
          ./tunnel-dash --help || exit 1
      
      - name: Test version flag
        run: |
          ./tunnel-dash --version || exit 1
      
      - name: Verify reproducible build
        run: |
          # Build twice and compare checksums
          go build -trimpath -buildvcs=false -ldflags "-X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Version=test -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Commit=abc123 -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.BuildDate=2024-01-01T00:00:00Z" -o tunnel-dash-1 ./cmd/tunnel-dash
          go build -trimpath -buildvcs=false -ldflags "-X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Version=test -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.Commit=abc123 -X github.com/azizoid/zero-trust-tunnel-dashboard/pkg/version.BuildDate=2024-01-01T00:00:00Z" -o tunnel-dash-2 ./cmd/tunnel-dash
          sha256sum tunnel-dash-1 tunnel-dash-2
          if [ "$(sha256sum tunnel-dash-1 | cut -d' ' -f1)" != "$(sha256sum tunnel-dash-2 | cut -d' ' -f1)" ]; then
            echo "ERROR: Builds are not reproducible!"
            exit 1
          fi
          echo "✓ Builds are reproducible"
